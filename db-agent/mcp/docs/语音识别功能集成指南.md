# 语音识别功能集成指南

## 概述

本项目已成功集成本地化语音识别功能，使用FireRedASR模型进行语音转文本，完全支持离线部署，无需联网。

**重要**: 语音识别服务作为独立服务运行，与主应用分离，运行在不同的端口上。

## 功能特性

- ✅ **本地化部署**: 使用FireRedASR模型，无需联网
- ✅ **实时录音**: 支持浏览器麦克风录音
- ✅ **音频格式转换**: 自动转换为16kHz WAV格式
- ✅ **中文识别**: 支持中文语音识别
- ✅ **用户友好**: 直观的录音按钮界面
- ✅ **错误处理**: 完善的错误提示和异常处理

## 系统要求

### 后端依赖
- Python 3.8+
- FireRedASR模型文件
- ffmpeg (用于音频格式转换)

### 前端依赖
- 现代浏览器 (支持Web Audio API)
- 麦克风权限

## 安装配置

### 1. 安装FireRedASR

```bash
# 克隆FireRedASR项目
git clone https://github.com/FireRedTeam/FireRedASR.git

# 安装依赖
cd FireRedASR
pip install -r requirements.txt

# 下载模型文件
# 将模型文件放置到 pretrained_models/FireRedASR-AED-L/ 目录
```

### 2. 安装ffmpeg

**Windows:**
```bash
# 使用chocolatey
choco install ffmpeg

# 或下载预编译版本
# https://ffmpeg.org/download.html
```

**Linux:**
```bash
sudo apt update
sudo apt install ffmpeg
```

**macOS:**
```bash
brew install ffmpeg
```

### 3. 配置环境变量

```bash
# 设置FireRedASR路径
export PATH=$PWD/FireRedASR/fireredasr/:$PWD/FireRedASR/fireredasr/utils/:$PATH
export PYTHONPATH=$PWD/FireRedASR/:$PYTHONPATH
```

## 使用方法

### 1. 启动主服务

```bash
# 启动主API服务器 (端口8000)
python main.py
```

### 2. 启动语音识别服务

```bash
# 直接运行语音识别服务 (端口8001)
python speech_service.py
```

### 3. 访问前端

打开浏览器访问: http://localhost:8000

### 4. 使用语音输入

1. 确保两个服务都在运行:
   - 主服务: http://localhost:8000
   - 语音识别服务: http://localhost:8001
2. 点击输入框右侧的麦克风按钮 🎤
3. 开始说话 (按钮会变红并显示停止图标)
4. 再次点击按钮停止录音
5. 等待语音识别完成
6. 识别结果会自动填入输入框
7. 点击发送按钮提交消息

## API接口

### 语音识别接口

**POST** `http://localhost:8001/api/speech/recognize`

上传音频文件进行语音识别

**请求:**
- Content-Type: `multipart/form-data`
- 参数: `audio` (音频文件)

**响应:**
```json
{
  "success": true,
  "text": "识别结果文本",
  "message": "语音识别成功"
}
```

### 服务状态接口

**GET** `http://localhost:8001/api/speech/status`

检查语音识别服务状态

**响应:**
```json
{
  "success": true,
  "fireredasr_available": true,
  "ffmpeg_available": true,
  "model_path": "/path/to/model",
  "message": "语音识别服务正常"
}
```

### 健康检查接口

**GET** `http://localhost:8001/health`

检查服务健康状态

**响应:**
```json
{
  "status": "healthy",
  "service": "speech-recognition"
}
```

## 技术实现

### 前端实现

- **录音功能**: 使用Web Audio API和MediaRecorder
- **音频处理**: 自动转换为16kHz单声道WAV格式
- **用户界面**: 自定义录音按钮，支持录音状态显示
- **错误处理**: 完善的错误提示和用户反馈

### 后端实现

- **音频转换**: 使用ffmpeg转换音频格式
- **语音识别**: 调用FireRedASR模型进行识别
- **文件处理**: 临时文件管理和清理
- **错误处理**: 完善的异常处理和日志记录

## 故障排除

### 常见问题

1. **麦克风权限被拒绝**
   - 确保浏览器有麦克风权限
   - 检查浏览器设置中的隐私设置

2. **FireRedASR模型未找到**
   - 确认模型文件已正确下载
   - 检查模型路径配置

3. **ffmpeg不可用**
   - 确认ffmpeg已正确安装
   - 检查系统PATH环境变量

4. **音频格式不支持**
   - 确保浏览器支持WebM格式
   - 检查音频编码器支持

### 调试方法

1. **检查主服务状态**
   ```bash
   # Windows PowerShell
   Invoke-WebRequest -Uri "http://localhost:8000/health"
   
   # Linux/Mac
   curl http://localhost:8000/health
   ```

2. **检查语音识别服务状态**
   ```bash
   # Windows PowerShell
   Invoke-WebRequest -Uri "http://localhost:8001/api/speech/status"
   
   # Linux/Mac
   curl http://localhost:8001/api/speech/status
   ```

3. **查看详细日志**
   
   语音识别服务会输出详细的处理日志：
   - 接收到的音频文件信息
   - ffmpeg转换命令和结果
   - FireRedASR执行过程
   - 识别结果或错误信息
   
   示例日志：
   ```
   INFO:__main__:执行ffmpeg命令: ffmpeg -i /tmp/xxx.wav ...
   INFO:__main__:ffmpeg转换成功
   INFO:__main__:执行FireRedASR命令: python fireredasr/speech2text.py ...
   INFO:__main__:识别结果: 我的数据库中有哪些表
   ```

4. **手动测试FireRedASR**
   
   在FireRedASR目录下测试：
   ```bash
   cd FireRedASR
   python fireredasr/speech2text.py --asr_type aed --model_dir pretrained_models/FireRedASR-AED-L --wav_path mic_input_16k.wav --use_gpu 0 --batch_size 1 --beam_size 1
   ```
   
   应该输出识别结果

## 性能优化

### 音频质量设置
- 采样率: 16kHz (平衡质量和性能)
- 声道: 单声道 (减少数据量)
- 编码: PCM 16-bit (保证质量)

### 模型选择
- 使用FireRedASR-AED-L模型 (平衡性能和准确率)
- 可根据需要切换到FireRedASR-LLM-L (更高准确率)

## 扩展功能

### 支持更多语言
修改FireRedASR配置以支持其他语言:
```python
# 在speech_api.py中修改模型参数
"--language", "en"  # 英语
"--language", "zh"  # 中文
```

### 实时流式识别
可以扩展为实时流式语音识别，支持连续对话。

### 语音合成
可以集成TTS功能，实现完整的语音交互。

## 服务架构

```
┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   主服务        │
│  (端口8000)     │    │  (端口8000)     │
│                 │    │                 │
│  - 聊天界面     │    │  - 数据库工具   │
│  - 语音按钮     │    │  - 对话管理     │
│  - 录音功能     │    │  - MCP工具      │
└─────────────────┘    └─────────────────┘
         │                       │
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌─────────────────┐
│ 语音识别服务    │    │   FireRedASR    │
│  (端口8001)     │    │                 │
│                 │    │  - 模型文件     │
│  - 音频接收     │    │  - 语音识别     │
│  - 格式转换     │    │  - 文本输出     │
│  - API接口      │    │                 │
└─────────────────┘    └─────────────────┘
```

## 独立部署优势

1. **环境隔离**: 语音识别服务可以运行在专门的Python环境中
2. **资源管理**: 可以独立配置语音识别服务的资源使用
3. **扩展性**: 可以轻松部署多个语音识别服务实例
4. **维护性**: 语音识别服务的更新不影响主应用
5. **故障隔离**: 语音识别服务故障不会影响主应用运行

## 更新日志

- **v1.0.0**: 初始版本，支持基础语音识别
- **v1.1.0**: 添加音频格式自动转换
- **v1.2.0**: 完善错误处理和用户反馈
- **v1.3.0**: 优化录音质量和性能
- **v2.0.0**: 重构为独立服务架构，支持分离部署
