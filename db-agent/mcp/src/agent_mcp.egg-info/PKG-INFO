Metadata-Version: 2.4
Name: agent-mcp
Version: 0.2.0
Summary: Modular MCP Agent with Database, File, Web, and Visualization Tools
Author-email: Agent MCP Team <team@agent-mcp.com>
License: MIT
Requires-Python: >=3.8
Description-Content-Type: text/markdown
Requires-Dist: mcp>=1.0.0
Requires-Dist: fastapi>=0.104.0
Requires-Dist: uvicorn>=0.24.0
Requires-Dist: sqlalchemy>=2.0.0
Requires-Dist: pymysql>=1.1.0
Requires-Dist: python-dotenv>=1.0.0
Requires-Dist: pydantic>=2.0.0
Requires-Dist: tenacity>=8.0.0
Requires-Dist: httpx>=0.25.0
Requires-Dist: openai>=1.0.0
Requires-Dist: requests>=2.31.0
Requires-Dist: aiofiles>=23.0.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: isort>=5.12.0; extra == "dev"

# Database Agent MCP Implementation

åŸºäº Model Context Protocol (MCP) çš„æ•°æ®åº“æ™ºèƒ½ä½“å®ç°ï¼Œæä¾›ä¸åŸ app ç›¸åŒçš„åŠŸèƒ½ï¼Œä½†é‡‡ç”¨æ›´ç°ä»£çš„ MCP æ¶æ„ã€‚

## é¡¹ç›®ç»“æ„

```
mcp/
â”œâ”€â”€ src/agent_mcp/
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ schemas.py       # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ tools/               # å·¥å…·æ¨¡å—
â”‚   â”‚   â””â”€â”€ database/        # æ•°æ®åº“å·¥å…·åŒ… (é‡æ„å)
â”‚   â”‚       â”œâ”€â”€ client.py              # ä¸»åè°ƒå™¨
â”‚   â”‚       â”œâ”€â”€ session_manager.py     # ä¼šè¯ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ execution_engine.py    # æ‰§è¡Œå¼•æ“
â”‚   â”‚       â”œâ”€â”€ action_executor.py     # åŠ¨ä½œæ‰§è¡Œå™¨
â”‚   â”‚       â”œâ”€â”€ query_strategy.py      # æŸ¥è¯¢ç­–ç•¥
â”‚   â”‚       â”œâ”€â”€ knowledge_manager.py   # çŸ¥è¯†ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ observation_processor.py # è§‚å¯Ÿå¤„ç†å™¨
â”‚   â”‚       â””â”€â”€ README.md              # æ•°æ®åº“å·¥å…·è¯¦ç»†æ–‡æ¡£
â”‚   â”œâ”€â”€ server.py            # MCP æœåŠ¡å™¨å®ç°
â”‚   â”œâ”€â”€ api.py               # FastAPI æ¥å£
â”‚   â”œâ”€â”€ memory.py            # è®°å¿†ç®¡ç†
â”‚   â”œâ”€â”€ guard.py             # SQL å®‰å…¨éªŒè¯
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ run_api.py               # å¯åŠ¨ API æœåŠ¡å™¨
â”œâ”€â”€ run_server.py            # å¯åŠ¨ MCP æœåŠ¡å™¨
â”œâ”€â”€ pyproject.toml           # é¡¹ç›®é…ç½®
â””â”€â”€ README.md                # æœ¬æ–‡æ¡£
```

## æ ¸å¿ƒç‰¹æ€§

### 1. MCP æ¶æ„
- **æœåŠ¡å™¨ç«¯**: æä¾›æ•°æ®åº“æ“ä½œå·¥å…· (list_tables, describe_table, run_sql, sample_rows)
- **å®¢æˆ·ç«¯**: å®ç° ReAct è§„åˆ’å’Œå·¥å…·è°ƒç”¨é€»è¾‘
- **åè®®**: åŸºäºæ ‡å‡† MCP åè®®è¿›è¡Œé€šä¿¡

### 2. æ¨¡å—åŒ–æ•°æ®åº“å·¥å…·åŒ… (é‡æ„å)
- **ä¸»åè°ƒå™¨ (client.py)**: ç»Ÿä¸€å…¥å£ï¼Œä»382è¡Œç²¾ç®€åˆ°205è¡Œ
- **ä¼šè¯ç®¡ç†å™¨ (session_manager.py)**: ä¸“é—¨å¤„ç†ç”¨æˆ·ä¼šè¯å’ŒçŠ¶æ€ç®¡ç†
- **æ‰§è¡Œå¼•æ“ (execution_engine.py)**: ä»»åŠ¡è§„åˆ’ã€æ‰§è¡Œæ§åˆ¶å’Œé”™è¯¯å¤„ç†
- **åŠ¨ä½œæ‰§è¡Œå™¨ (action_executor.py)**: å…·ä½“æ•°æ®åº“æ“ä½œçš„æ‰§è¡Œå’ŒéªŒè¯
- **æŸ¥è¯¢ç­–ç•¥ (query_strategy.py)**: æ™ºèƒ½æŸ¥è¯¢å†³ç­–å’ŒSQLç”Ÿæˆ
- **çŸ¥è¯†ç®¡ç†å™¨ (knowledge_manager.py)**: æ•°æ®åº“ç»“æ„å­¦ä¹ å’ŒçŸ¥è¯†ç§¯ç´¯
- **è§‚å¯Ÿå¤„ç†å™¨ (observation_processor.py)**: ç»“æœåˆ†æå’Œæ™ºèƒ½è§£é‡Š

### 3. ä¸åŸ app å…¼å®¹
- æä¾›ç›¸åŒçš„ `/plan` æ¥å£
- æ”¯æŒä¼šè¯ç®¡ç† (thread_id)
- ä¿æŒç›¸åŒçš„å“åº”æ ¼å¼
- å…¼å®¹åŸæœ‰çš„æ•°æ®åº“æ¥å£

### 4. å®‰å…¨æœºåˆ¶
- SQL æ³¨å…¥é˜²æŠ¤
- åªè¯»æŸ¥è¯¢éªŒè¯
- LIMIT å­å¥å¼ºåˆ¶æ·»åŠ 
- å±é™©æ“ä½œé»‘åå•

### 5. æ™ºèƒ½ç‰¹æ€§
- **è‡ªç„¶è¯­è¨€ç†è§£**: ç†è§£ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢éœ€æ±‚
- **è‡ªåŠ¨è¡¨å‘ç°**: æ ¹æ®æŸ¥è¯¢å†…å®¹è‡ªåŠ¨è¯†åˆ«ç›¸å…³è¡¨
- **æ™ºèƒ½SQLç”Ÿæˆ**: ç”Ÿæˆä¼˜åŒ–çš„SQLæŸ¥è¯¢è¯­å¥
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**: åŸºäºå¯¹è¯å†å²æä¾›æ›´å‡†ç¡®çš„æŸ¥è¯¢
- **é”™è¯¯è‡ªæ„ˆ**: è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤SQLè¯­æ³•é”™è¯¯

### 6. è®°å¿†ç®¡ç†
- ä¼šè¯çŠ¶æ€æŒä¹…åŒ–
- çŸ¥è¯†ç¼“å­˜ (known_tables, known_schemas)
- æ­¥éª¤å†å²è®°å½•
- ä¸Šä¸‹æ–‡æ‘˜è¦ç”Ÿæˆ

## å®‰è£…å’Œè¿è¡Œ

### 1. å®‰è£…ä¾èµ–

```bash
cd mcp
pip install -e .
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“é…ç½®
DATABASE_URL=sqlite:///path/to/your/database.db

# LLM é…ç½®
OPENAI_API_KEY=your_openai_api_key
OPENAI_BASE_URL=https://api.openai.com/v1
LLM_MODEL=gpt-4

# æœåŠ¡é…ç½®
MCP_API_PORT=9623
```

### 3. å¯åŠ¨æœåŠ¡

#### æ–¹å¼ä¸€ï¼šå¯åŠ¨ FastAPI æ¥å£ (æ¨è)

```bash
python run_api.py
```

è®¿é—® http://localhost:9623/docs æŸ¥çœ‹ API æ–‡æ¡£

#### æ–¹å¼äºŒï¼šåˆ†åˆ«å¯åŠ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯

```bash
# ç»ˆç«¯1: å¯åŠ¨ MCP æœåŠ¡å™¨
python run_server.py

# ç»ˆç«¯2: ä½¿ç”¨å®¢æˆ·ç«¯
python -c "
import asyncio
from src.db_agent_mcp.client import DatabaseMCPClient

async def test():
    client = DatabaseMCPClient()
    async with client.connect_to_server(['python', 'run_server.py']):
        result = await client.call_tool('list_tables', {})
        print(result)

asyncio.run(test())
"
```

## API æ¥å£

### ä¸»è¦æ¥å£

#### POST /plan
ä¸åŸ app å…¼å®¹çš„è§„åˆ’æ¥å£

```json
{
  "question": "ç»Ÿè®¡ user è¡¨æ€»æ•°",
  "thread_id": "optional_session_id",
  "max_steps": 12
}
```

å“åº”ï¼š
```json
{
  "ok": true,
  "answer": {"ok": true, "data": [{"total": 1000}]},
  "steps": [...],
  "known_tables": ["user", "order"],
  "thread_id": "session_id"
}
```

#### ä¼šè¯ç®¡ç†
- `GET /sessions` - åˆ—å‡ºæ‰€æœ‰ä¼šè¯
- `GET /sessions/{session_id}` - è·å–ä¼šè¯è¯¦æƒ…
- `DELETE /sessions/{session_id}` - åˆ é™¤ä¼šè¯

#### æ•°æ®åº“æ¥å£
- `POST /list_tables` - åˆ—å‡ºæ‰€æœ‰è¡¨
- `POST /describe_table` - æè¿°è¡¨ç»“æ„
- `POST /read_query` - æ‰§è¡Œ SQL æŸ¥è¯¢

## æ•°æ®åº“å·¥å…·åŒ…ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

```python
from src.agent_mcp.tools.database.client import DatabaseMCPClient

# åˆ›å»ºæ•°æ®åº“å®¢æˆ·ç«¯
client = DatabaseMCPClient()

# æ‰§è¡Œè‡ªç„¶è¯­è¨€æŸ¥è¯¢
result = await client.plan_and_execute(
    question="æŸ¥æ‰¾é”€å”®é¢æœ€é«˜çš„å‰10ä¸ªäº§å“",
    max_steps=10
)

print(result)
```

### è¯¦ç»†æ–‡æ¡£

æ•°æ®åº“å·¥å…·åŒ…çš„è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒï¼š
ğŸ“– [æ•°æ®åº“å·¥å…·åŒ…è¯¦ç»†æ–‡æ¡£](src/agent_mcp/tools/database/README.md)

è¯¥æ–‡æ¡£åŒ…å«ï¼š
- ğŸ—ï¸ å®Œæ•´çš„æ¶æ„è®¾è®¡è¯´æ˜
- ğŸš€ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ä»‹ç»
- ğŸ“¦ å„æ¨¡å—è¯¦ç»†è¯´æ˜
- ğŸ”§ ä½¿ç”¨æ–¹æ³•å’Œç¤ºä¾‹
- ğŸ¯ ç‰¹è‰²åŠŸèƒ½å±•ç¤º
- ğŸ§ª æµ‹è¯•å’Œé…ç½®æŒ‡å—

### é‡æ„æˆæœ

ç»è¿‡æ¨¡å—åŒ–é‡æ„ï¼Œæ•°æ®åº“å·¥å…·åŒ…ç°åœ¨å…·æœ‰ï¼š
- âœ… **ä»£ç ç²¾ç®€**: client.pyä»382è¡Œå‡å°‘åˆ°205è¡Œ (å‡å°‘46%)
- âœ… **æ¨¡å—åŒ–è®¾è®¡**: 7ä¸ªä¸“ç”¨æ¨¡å—ï¼Œå„å¸å…¶èŒ
- âœ… **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½
- âœ… **æ˜“äºæ‰©å±•**: æ–°åŠŸèƒ½å¯ä»¥ç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•
- âœ… **é«˜å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ¥å£è®¾è®¡

## æµ‹è¯•

### è¿è¡Œæµ‹è¯•
```bash
# ä½¿ç”¨pytestè¿è¡Œæµ‹è¯•å¥—ä»¶
python -m pytest tests/ -v

# æˆ–è€…è¿è¡Œç‰¹å®šçš„æµ‹è¯•æ¨¡å—
python -m pytest tests/test_database_tools.py -v
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
1. MCP å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨
2. FastAPI æ¥å£æµ‹è¯•
3. ä¸åŸ app åŠŸèƒ½å¯¹æ¯”
4. è®°å¿†ç®¡ç†å™¨æµ‹è¯•
5. æ¨¡å—åŒ–ç»„ä»¶æµ‹è¯•
6. é‡æ„ååŠŸèƒ½å®Œæ•´æ€§éªŒè¯

## MCP vs åŸ app å¯¹æ¯”

| ç‰¹æ€§ | åŸ app | MCP å®ç° |
|------|--------|----------|
| æ¶æ„ | LangGraph + FastAPI | MCP Server + Client |
| å·¥å…·è°ƒç”¨ | å†…ç½®å‡½æ•° | MCP åè®® |
| çŠ¶æ€ç®¡ç† | LangGraph MemorySaver | è‡ªå®šä¹‰ MemoryManager |
| æ‰©å±•æ€§ | å•ä½“åº”ç”¨ | åˆ†å¸ƒå¼æ¶æ„ |
| åè®®æ ‡å‡† | è‡ªå®šä¹‰ | æ ‡å‡† MCP åè®® |
| éƒ¨ç½²æ–¹å¼ | å•è¿›ç¨‹ | å¤šè¿›ç¨‹/åˆ†å¸ƒå¼ |

## ä¼˜åŠ¿

1. **æ ‡å‡†åŒ–**: åŸºäº MCP æ ‡å‡†åè®®ï¼Œæ›´å¥½çš„äº’æ“ä½œæ€§
2. **æ¨¡å—åŒ–**: æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åˆ†ç¦»ï¼Œä¾¿äºç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
3. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„å·¥å…·å’ŒåŠŸèƒ½
4. **å…¼å®¹æ€§**: ä¿æŒä¸åŸ app çš„ API å…¼å®¹
5. **å®‰å…¨æ€§**: ç»§æ‰¿åŸæœ‰çš„å®‰å…¨æœºåˆ¶

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°å·¥å…·

1. åœ¨ `server.py` ä¸­å®šä¹‰æ–°å·¥å…·
2. åœ¨ `client.py` ä¸­æ·»åŠ è°ƒç”¨é€»è¾‘
3. æ›´æ–° `schemas.py` ä¸­çš„åŠ¨ä½œç±»å‹

### æ‰©å±•è®°å¿†åŠŸèƒ½

1. ä¿®æ”¹ `AgentState` æ¨¡å‹
2. æ›´æ–° `MemoryManager` ç±»
3. è°ƒæ•´ä¸Šä¸‹æ–‡æ‘˜è¦é€»è¾‘

### è‡ªå®šä¹‰å®‰å…¨ç­–ç•¥

1. ä¿®æ”¹ `guard.py` ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼
2. æ·»åŠ æ–°çš„éªŒè¯å‡½æ•°
3. æ›´æ–°é»‘åå•è§„åˆ™

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**: æ£€æŸ¥ MCP æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å¯åŠ¨
2. **æ•°æ®åº“é”™è¯¯**: éªŒè¯ DATABASE_URL é…ç½®
3. **LLM è°ƒç”¨å¤±è´¥**: æ£€æŸ¥ API å¯†é’¥å’Œç½‘ç»œè¿æ¥
4. **æƒé™é”™è¯¯**: ç¡®ä¿æ•°æ®åº“æ–‡ä»¶å¯è¯»å†™

### è°ƒè¯•æ¨¡å¼

è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨è°ƒè¯•ï¼š

```bash
export DEBUG=1
python run_api.py
```

## è®¸å¯è¯

ä¸åŸé¡¹ç›®ä¿æŒä¸€è‡´çš„è®¸å¯è¯ã€‚

## æ¶æ„è®¾è®¡

- **MCP Server**: æä¾›æ•°æ®åº“æ“ä½œå·¥å…· (list_tables, describe_table, run_sql ç­‰)
- **MCP Client**: å¤„ç† ReAct è§„åˆ’å’Œå·¥å…·è°ƒç”¨é€»è¾‘
- **State Management**: å®ç°çŠ¶æ€ç®¡ç†å’Œè®°å¿†æœºåˆ¶
- **FastAPI Interface**: æä¾›ä¸åŸ app ç›¸åŒçš„ `/plan` ç«¯ç‚¹

## å®‰è£…

```bash
cd mcp
pip install -e .
```

## é…ç½®

å¤åˆ¶ app ç›®å½•çš„ `.env` æ–‡ä»¶åˆ° mcp ç›®å½•ï¼š
```bash
cp ../app/.env .env
```

## è¿è¡Œ

å¯åŠ¨ MCP æœåŠ¡å™¨ï¼š
```bash
db-agent-mcp-server
```

å¯åŠ¨ FastAPI æ¥å£ï¼š
```bash
uvicorn db_agent_mcp.api:app --host 0.0.0.0 --port 9623
```

## ç‰¹æ€§

- âœ… ä¸åŸ app ç›¸åŒçš„ ReAct è§„åˆ’é€»è¾‘
- âœ… æ™ºèƒ½è¡¨ä¼˜å…ˆçº§æ’åº
- âœ… çŠ¶æ€ç¼“å­˜å’Œè®°å¿†æœºåˆ¶
- âœ… SQL å®‰å…¨å®ˆå«
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… ä¸­æ–‡ç¼–ç ä¿®å¤
- âœ… è®¡æ•°é—®é¢˜è¯†åˆ«å’Œä¼˜åŒ–
