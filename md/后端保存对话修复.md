# ğŸ”§ åç«¯ä¿å­˜å¯¹è¯ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

### 404 é”™è¯¯
```
GET http://localhost:8000/api/conversation/4b582dcd-0340-45cd-a892-a7f305940efc 404 (Not Found)
âš ï¸ [ä¼šè¯ç®¡ç†] åç«¯æœªæ‰¾åˆ°æ­¤ä¼šè¯ï¼Œå°†ä½¿ç”¨æœ¬åœ°ç¼“å­˜
```

### æ ¹æœ¬åŸå› 

**åç«¯æµå¼ API (`/api/conversation/plan/stream`) ä»æ¥æ²¡æœ‰ä¿å­˜å¯¹è¯åˆ°æ•°æ®åº“ï¼**

#### é—®é¢˜æµç¨‹ï¼š

1. âœ… å‰ç«¯è°ƒç”¨ `/api/conversation/plan/stream`
2. âœ… åç«¯æ‰§è¡Œ ReAct æ¨ç†ï¼Œç”Ÿæˆå›ç­”
3. âœ… è¿”å› `thread_id` å’Œæ­¥éª¤æ•°æ®
4. âœ… å‰ç«¯å®Œæ•´è¯»å–æµ
5. âŒ **åç«¯æ²¡æœ‰è°ƒç”¨ `save_conversation`**
6. âŒ **æ•°æ®åº“ä¸­æ²¡æœ‰è¿™ä¸ª `thread_id` çš„è®°å½•**
7. âŒ åˆ‡æ¢ä¼šè¯æ—¶ï¼Œè°ƒç”¨ `GET /api/conversation/{thread_id}` è¿”å› 404

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼š`src/api/complete_api.py`

#### å…³é”®æ”¹åŠ¨ï¼š

1. **æ”¶é›†å¯¹è¯çŠ¶æ€**ï¼š
   ```python
   collected_state = {
       "question": request.question,
       "steps": [],
       "answer": None,
       "done": False,
       "messages": []  # ç”¨æˆ·æ¶ˆæ¯ + AIå›ç­”
   }
   ```

2. **åœ¨æµå¼å¤„ç†ä¸­æ”¶é›†æ•°æ®**ï¼š
   ```python
   async for step_data in conversation_manager.run_conversation_stream(...):
       # æ”¶é›†æ­¥éª¤
       if step_data["type"] == "step":
           collected_state["steps"].append(step_data["data"])
       elif step_data["type"] == "finish":
           collected_state["done"] = True
           collected_state["answer"] = step_data["data"].get("answer", "")
           collected_state["messages"].append({
               "role": "assistant",
               "content": step_data["data"].get("answer", "")
           })
       
       yield step_data  # ç»§ç»­æµå¼è¾“å‡º
   ```

3. **æµç»“æŸåä¿å­˜åˆ°æ•°æ®åº“**ï¼š
   ```python
   # æ„å»ºçŠ¶æ€å¯¹è±¡
   state = AgentState(
       question=collected_state["question"],
       messages=collected_state["messages"],
       steps=collected_state["steps"],
       done=collected_state["done"],
       answer={"ok": True, "data": collected_state["answer"]},
       ...
   )
   
   # ä¿å­˜åˆ°æ•°æ®åº“
   metadata = ConversationMetadata(
       thread_id=thread_id,
       title=request.question[:50],
       ...
   )
   
   conversation_manager.save_conversation(metadata, state)
   print(f"âœ… [API] å¯¹è¯å·²ä¿å­˜åˆ°æ•°æ®åº“: {thread_id}")
   ```

4. **å‘é€ final äº‹ä»¶**ï¼š
   ```python
   # å‘é€æœ€ç»ˆç­”æ¡ˆï¼ˆç”¨äºå‰ç«¯éªŒè¯ï¼‰
   yield f"data: {json.dumps({{'type': 'final', 'data': {{'content': collected_state['answer'], 'thread_id': thread_id}}}})}\n\n"
   yield f"data: {json.dumps({'type': 'complete', 'data': {'thread_id': thread_id}})}\n\n"
   ```

## ğŸ” ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼š

```
å‘é€æ¶ˆæ¯
  â†“
åç«¯æ‰§è¡Œ ReAct
  â†“
è¿”å› thread_id
  â†“
âŒ æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“
  â†“
åˆ‡æ¢ä¼šè¯
  â†“
GET /api/conversation/{thread_id}
  â†“
âŒ 404 Not Found
```

### ä¿®å¤åï¼š

```
å‘é€æ¶ˆæ¯
  â†“
åç«¯æ‰§è¡Œ ReAct
  â†“
è¿”å› thread_id
  â†“
âœ… ä¿å­˜åˆ°æ•°æ®åº“
  â†“
åç«¯æ—¥å¿—: "âœ… [API] å¯¹è¯å·²ä¿å­˜åˆ°æ•°æ®åº“: xxx"
  â†“
åˆ‡æ¢ä¼šè¯
  â†“
GET /api/conversation/{thread_id}
  â†“
âœ… 200 OKï¼Œè¿”å›å¯¹è¯å†å²
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ­¥éª¤ 1ï¼šé‡å¯åç«¯

```bash
# åœ¨åç«¯ç›®å½•è¿è¡Œ
python main.py
```

### æ­¥éª¤ 2ï¼šæ¸…ç©ºå‰ç«¯å¹¶æµ‹è¯•

```javascript
localStorage.clear();
location.reload();
```

### æ­¥éª¤ 3ï¼šåˆ›å»ºä¼šè¯ A

1. æ–°å»ºä¼šè¯
2. å‘é€æ¶ˆæ¯ "ä½ å¥½1"

**é¢„æœŸæ—¥å¿—**ï¼š

**å‰ç«¯ï¼š**
```
ğŸ”„ [æµ‹è¯•æ¨¡å¼] å¼€å§‹è¯»å–åç«¯æµ...
ğŸ“‹ [æµ‹è¯•æ¨¡å¼] è·å– thread_id: xxxxxxxx-1...
ğŸ“ [æµ‹è¯•æ¨¡å¼] åç«¯çœŸå®å›ç­”: ...
âœ… [æµ‹è¯•æ¨¡å¼] åç«¯æµè¯»å–å®Œæˆ

åç«¯å·²ä¿å­˜çœŸå®å›ç­”: æ˜¯
```

**åç«¯ï¼š**
```
âœ… [API] å¯¹è¯å·²ä¿å­˜åˆ°æ•°æ®åº“: xxxxxxxx-1
```

### æ­¥éª¤ 4ï¼šåˆ›å»ºä¼šè¯ B

1. æ–°å»ºä¼šè¯
2. å‘é€æ¶ˆæ¯ "ä½ å¥½2"

**é¢„æœŸåç«¯æ—¥å¿—**ï¼š
```
âœ… [API] å¯¹è¯å·²ä¿å­˜åˆ°æ•°æ®åº“: yyyyyyyy-2
```

### æ­¥éª¤ 5ï¼šåˆ‡æ¢å›ä¼šè¯ A

**é¢„æœŸå‰ç«¯æ—¥å¿—**ï¼š
```
ğŸ“¡ [ä¼šè¯åˆ‡æ¢] ä»åç«¯åŠ è½½: æ–°ä¼šè¯
   ç›®æ ‡ threadId: xxxxxxxx-1...

âœ… [ä¼šè¯åˆ‡æ¢] åç«¯åŠ è½½æˆåŠŸ    âœ… ä¸å† 404ï¼
   åŠ è½½çš„ threadId: xxxxxxxx-1...
   æ¶ˆæ¯æ•°: 2
   ç¬¬ä¸€æ¡æ¶ˆæ¯: ä½ å¥½1...
```

**é¢„æœŸåç«¯æ—¥å¿—**ï¼š
```
200 GET /api/conversation/xxxxxxxx-1    âœ… æˆåŠŸè¿”å›
```

### æ­¥éª¤ 6ï¼šéªŒè¯æ•°æ®åº“

å¯ä»¥ç›´æ¥æŸ¥çœ‹æ•°æ®åº“ï¼š

```bash
# åœ¨åç«¯ç›®å½•
sqlite3 conversations.db

# æŸ¥çœ‹æ‰€æœ‰å¯¹è¯
SELECT thread_id, title, created_at FROM conversations;

# æŸ¥çœ‹ç‰¹å®šå¯¹è¯çš„çŠ¶æ€
SELECT state_data FROM conversations WHERE thread_id = 'xxxxxxxx-1';
```

åº”è¯¥èƒ½çœ‹åˆ°ï¼š
- âœ… ä¸¤æ¡è®°å½•ï¼ˆä¼šè¯ A å’Œä¼šè¯ Bï¼‰
- âœ… æ¯æ¡è®°å½•éƒ½æœ‰å®Œæ•´çš„ `state_data`
- âœ… `state_data` åŒ…å« `messages` å­—æ®µ

## ğŸ“Š æ•°æ®ç»“æ„

### conversations è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| thread_id | TEXT | ä¸»é”®ï¼Œä¼šè¯ID |
| user_id | TEXT | ç”¨æˆ·ID |
| title | TEXT | ä¼šè¯æ ‡é¢˜ï¼ˆé—®é¢˜å‰50å­—ç¬¦ï¼‰ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ |
| tool_categories | TEXT | å·¥å…·åˆ†ç±»ï¼ˆJSONï¼‰ |
| tags | TEXT | æ ‡ç­¾ï¼ˆJSONï¼‰ |
| state_data | TEXT | **å®Œæ•´çš„ä¼šè¯çŠ¶æ€ï¼ˆJSONï¼‰** |

### state_data å†…å®¹

```json
{
  "question": "ä½ å¥½1",
  "messages": [
    {"role": "user", "content": "ä½ å¥½1"},
    {"role": "assistant", "content": "æ ¹æ®æ‚¨çš„é—®é¢˜..."}
  ],
  "steps": [...],
  "done": true,
  "answer": {"ok": true, "data": "..."},
  "max_steps": 12,
  ...
}
```

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

1. **å®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨**ï¼š
   - ä¿å­˜äº†ç”¨æˆ·æ¶ˆæ¯å’Œ AI å›ç­”
   - æ ¼å¼ä¸ LangChain/LangGraph çš„ `messages` å…¼å®¹

2. **æ­¥éª¤å†å²**ï¼š
   - ä¿å­˜äº†æ‰€æœ‰ ReAct æ­¥éª¤
   - å¯ä»¥ç”¨äºè°ƒè¯•å’Œåˆ†æ

3. **çŠ¶æ€æŒä¹…åŒ–**ï¼š
   - ä¿å­˜äº†å®Œæ•´çš„ `AgentState`
   - å¯ä»¥æ¢å¤å¯¹è¯ä¸Šä¸‹æ–‡

4. **å‰ç«¯éªŒè¯**ï¼š
   - æ·»åŠ äº† `final` äº‹ä»¶ï¼ŒåŒ…å«æœ€ç»ˆç­”æ¡ˆ
   - å‰ç«¯å¯ä»¥éªŒè¯åç«¯æ˜¯å¦çœŸæ­£å¤„ç†å®Œæˆ

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **åç«¯å¿…é¡»é‡å¯**ï¼š
   - ä¿®æ”¹äº† `src/api/complete_api.py`
   - éœ€è¦é‡å¯åç«¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ

2. **æ•°æ®åº“ä½ç½®**ï¼š
   - é»˜è®¤ï¼š`conversations.db`ï¼ˆåœ¨åç«¯æ ¹ç›®å½•ï¼‰
   - å¯ä»¥é€šè¿‡ `ConversationManager(db_path=...)` ä¿®æ”¹

3. **æ€§èƒ½è€ƒè™‘**ï¼š
   - æ¯æ¬¡å¯¹è¯éƒ½ä¼šä¿å­˜å®Œæ•´çŠ¶æ€
   - å¦‚æœå¯¹è¯å¾ˆé•¿ï¼Œ`state_data` å¯èƒ½å¾ˆå¤§
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ æ¸…ç†æœºåˆ¶

4. **é”™è¯¯å¤„ç†**ï¼š
   - å¦‚æœä¿å­˜å¤±è´¥ï¼Œå‰ç«¯ä»ç„¶å¯ä»¥çœ‹åˆ°å›ç­”
   - ä½†åˆ‡æ¢ä¼šè¯æ—¶ä¼š 404
   - åº”è¯¥æ·»åŠ ä¿å­˜å¤±è´¥çš„æç¤º

## ğŸ”„ å‰åç«¯åä½œ

### å‰ç«¯èŒè´£ï¼š
- âœ… å®Œæ•´è¯»å– SSE æµ
- âœ… è§£æ `final` äº‹ä»¶éªŒè¯åç«¯ä¿å­˜
- âœ… åˆ‡æ¢ä¼šè¯æ—¶ä»åç«¯åŠ è½½

### åç«¯èŒè´£ï¼š
- âœ… æ‰§è¡Œ ReAct æ¨ç†
- âœ… æµå¼è¾“å‡ºæ­¥éª¤æ•°æ®
- âœ… **æ”¶é›†å®Œæ•´çŠ¶æ€å¹¶ä¿å­˜åˆ°æ•°æ®åº“**
- âœ… æä¾› `GET /api/conversation/{thread_id}` æ¥å£

## ğŸ“ æ€»ç»“

è¿™ä¸ªä¿®å¤è§£å†³äº†**åç«¯ä¸ä¿å­˜å¯¹è¯**çš„æ ¹æœ¬é—®é¢˜ï¼š

- âŒ ä¿®å¤å‰ï¼šåç«¯åªæ‰§è¡Œå¯¹è¯ï¼Œä¸ä¿å­˜
- âœ… ä¿®å¤åï¼šåç«¯æ‰§è¡Œå¯¹è¯åï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“

ç°åœ¨å‰ç«¯çš„ä¼šè¯ç®¡ç†åŠŸèƒ½å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼š
- âœ… åˆ‡æ¢ä¼šè¯èƒ½åŠ è½½å†å²æ¶ˆæ¯
- âœ… åˆ·æ–°é¡µé¢èƒ½æ¢å¤ä¼šè¯
- âœ… æ¯ä¸ªä¼šè¯æœ‰ç‹¬ç«‹çš„ `thread_id` å’Œå†å²

---

**è¯·é‡å¯åç«¯æœåŠ¡å¹¶é‡æ–°æµ‹è¯•ï¼** ğŸš€

